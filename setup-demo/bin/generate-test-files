#!/usr/bin/env ruby
require "yaml"

MANIFEST = ARGV[0]
CHANNEL = ENV["CHANNEL"] || MANIFEST.sub(/^(.*\/)?restylers-([^\.]+).yaml$/, '\2')
LIMIT = ENV["LIMIT"] || ""
LIMIT = LIMIT.empty? ? nil : LIMIT.to_i
DRY_RUN = !(ENV["DRY_RUN"] || "").empty?

puts "Generating Restyled test files"
puts "  Manifest: #{MANIFEST}"
puts "  Channel : #{CHANNEL}"
puts "  Limit   : #{LIMIT}"
puts "  Dry run?: #{DRY_RUN}"

def generate(restyler)
  name = restyler.fetch("name")

  restyler.fetch("metadata").fetch("tests").each.with_index do |test, idx|
    generate_test(idx, name, restyler.fetch("include"), test)

    if (support = test["support"])
      write_file(support.fetch("path"), support.fetch("contents"))
    end
  end

  {
    "name" => name,
    "enabled" => true,
    "include" => ["#{name}-test-*"]
  }
end

def generate_test(number, name, includes, test)
  path = test_file_name(number, name, includes, test["extension"])
  write_file(path, test.fetch("contents"))
end

def test_file_name(number, name, includes, extension)
  "#{name}-test-#{number}.#{extension || guess_extension(includes) || "tmp"}"
end

def guess_extension(includes)
  include = includes.find do |x|
    !x.start_with?("!") && x.include?(".")
  end

  include&.sub(/.*\.([^.]+)$/, '\1')
end

def write_file(path, contents)
  puts "WRITE #{path}"

  unless DRY_RUN
    File.write(path, contents)
  end
end

all_restylers = YAML.safe_load_file(MANIFEST)
puts "Manifest contains #{all_restylers.length} Restylers"

restylers = all_restylers.shuffle.take(LIMIT || all_restylers.length)
puts "Limited to #{restylers.length} Restyler(s)"

config_restylers = restylers.map do |restyler|
  generate(restyler)
end

write_file(".restyled.yaml", YAML.dump({
  "restylers_version" => CHANNEL,
  "restylers" => config_restylers
}))
